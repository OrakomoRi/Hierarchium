document.addEventListener("DOMContentLoaded",function(){const t=document.querySelector(".container"),e=document.createElement("div");e.className="modal_container";const s=(t=[],s=null)=>{e.innerHTML=`\n\t\t\t<div class="modal">\n\t\t\t\t<h1>${s?"Edit Section":"Create Section"}</h1>\n\t\t\t\t<form class="modal_form">\n\t\t\t\t\t<label for="title">Title:</label>\n\t\t\t\t\t<input type="text" class="title" name="title" maxlength="40" required value="${s?s.title:"section"}">\n\t\t\t\t\t<label for="description">Description:</label>\n\t\t\t\t\t<textarea class="description" name="description" maxlength="400" required>${s?s.description:"Lorem ipsum dolor sit amet consectetur adipisicing elit. Sapiente, labore?"}</textarea>\n\t\t\t\t\t${t.length?`\n\t\t\t\t\t\t<label>Parent:</label>\n\t\t\t\t\t\t<div class="parent_id custom_select">\n\t\t\t\t\t\t\t<span class="custom_select_selected" data-value="${s&&s.parent_id?s.parent_id:"none"}">\n\t\t\t\t\t\t\t\t${s&&s.parent_id?(()=>{var e=t.find(function(t){return t.id===s.parent_id});return e?`<span class="option_name">${e.name}</span>&nbsp;<span>#${e.id}</span>`:"&lt;none&gt;"})():"&lt;none&gt;"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t<div class="custom_select_options">\n\t\t\t\t\t\t\t\t<span data-value="none">&lt;none&gt;</span>\n\t\t\t\t\t\t\t\t${t.filter(t=>!s||t.id!==s.id).map(t=>`\n\t\t\t\t\t\t\t\t\t\t<span data-value="${t.id}" ${s&&s.parent_id===t.id?'class="selected"':""}>\n\t\t\t\t\t\t\t\t\t\t\t<span class="option_name">${t.name}</span>&nbsp;<span>#${t.id}</span>\n\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t`).join("")}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`:""}\n\t\t\t\t\t<button type="submit">${s?"Save":"Create"}</button>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t`,document.body.classList.add("no-scroll"),document.body.appendChild(e);const o=e.querySelector(".modal button");o&&o.focus();const a=e.querySelector(".custom_select");if(a){const t=a.querySelector(".custom_select_selected"),e=a.querySelector(".custom_select_options"),s=e.querySelectorAll("span");t.addEventListener("click",()=>{e.classList.toggle("show"),n()}),s.forEach(n=>{n.addEventListener("click",()=>{t.innerHTML=n.innerHTML,t.dataset.value=n.dataset.value,e.classList.remove("show"),s.forEach(t=>t.classList.remove("selected")),n.classList.add("selected")})}),window.addEventListener("click",t=>{a.contains(t.target)||e.classList.remove("show")})}e.querySelector(".modal_form").addEventListener("submit",t=>{t.preventDefault();const e=new FormData(t.target);if(a){const t=a.querySelector(".custom_select_selected");e.append("parent_id","none"===t.dataset.value?null:t.dataset.value)}else e.append("parent_id",null);s?c(s,e):i(e)})},n=()=>{const t=e.querySelectorAll(".custom_select");t.forEach(t=>{const e=t.querySelector(".custom_select_options"),s=e.querySelectorAll("span");if(0===s.length)return;e.style.maxHeight="none";const n=s[0].offsetHeight,o=4,i=Math.min(s.length,o)*n;e.style.maxHeight=`${i}px`})},o=()=>{const t=e.querySelectorAll(".custom_select_options.show");t.forEach(t=>{t.classList.remove("show")})};window.addEventListener("resize",o);const i=s=>{fetch("/sections/create",{method:"POST",body:s,headers:{"X-Requested-With":"XMLHttpRequest"}}).then(t=>t.text()).then(n=>{try{const i=JSON.parse(n);if(i.success)if(i.section){var o=document.querySelector(".no-sections");o&&o.remove();const n=s.get("parent_id");if("null"===n)d([i.section],t);else{const e=t.querySelector(`.section[data-id="${n}"]`);if(e){let t=e.querySelector(".subsections");t||(t=document.createElement("div"),t.className="subsections",e.querySelector(".section_body").appendChild(t)),d([i.section],t)}else showNotificationMessage("Parent section not found","error")}document.body.removeChild(e)}else showNotificationMessage("Section data is missing","error");else showNotificationMessage(i.error,"error")}catch(t){showNotificationMessage("Failed to parse JSON: "+t.message,"error")}}).catch(t=>showNotificationMessage("Error: "+t.message,"error"))},c=(s,n)=>{n.append("id",s.id),fetch("/sections/update",{method:"POST",body:n,headers:{"X-Requested-With":"XMLHttpRequest"}}).then(t=>t.text()).then(o=>{try{const i=JSON.parse(o);if(i.success){const o=t.querySelector(`.section[data-id="${s.id}"]`);if(o){const i=o.querySelector(".section_header h3"),c=o.querySelector(".section_body p"),a=i.querySelector(".section_id");i.innerHTML=`${n.get("title")} `,a&&i.appendChild(a),c.innerText=n.get("description");const r=n.get("parent_id"),l=o.dataset.parent_id;if(l!==r){if(l){const e=t.querySelector(`.section[data-id="${l}"] .subsections`);e&&e.removeChild(o)}if(r){const e=t.querySelector(`.section[data-id="${r}"]`);if(e){let t=e.querySelector(".subsections");t||(t=document.createElement("div"),t.className="subsections",e.querySelector(".section_body").appendChild(t)),t.appendChild(o)}}else t.appendChild(o);o.dataset.parent_id=r}document.body.removeChild(e),document.body.classList.remove("no-scroll"),r&&(s.parent_id=r),s.title=n.get("title"),s.description=n.get("description")}}else showNotificationMessage(i.error,"error")}catch(t){showNotificationMessage("Failed to parse JSON: "+t.message,"error")}}).catch(t=>showNotificationMessage("Error: "+t.message,"error"))},a=()=>Array.from(t.querySelectorAll(".section")).map(t=>({id:t.dataset.id,name:t.querySelector(".section_header h3").innerText}));document.querySelector(".create").addEventListener("click",()=>{const t=a();s(t)}),window.addEventListener("mousedown",function(t){t.target===e&&(document.body.removeChild(e),document.body.classList.remove("no-scroll"))});const r=()=>{fetch("/sections/get",{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(t=>t.json()).then(t=>{t.success?d(t.sections):showNotificationMessage(t.error,"error")}).catch(t=>showNotificationMessage("Error: "+t.message,"error"))},l=t=>{let e=0;const s=t.querySelectorAll(".section");return e+=s.length,s.forEach(t=>{e+=l(t)}),e},d=(e,n=t)=>{if(e.forEach(e=>{const o=n.querySelector(`.section[data-id="${e.id}"]`);if(o)return;const i=document.createElement("div");if(i.className="section",i.dataset.id=e.id,i.dataset.parent_id=e.parent_id,i.innerHTML=`\n\t\t\t\t<div class="section_header">\n\t\t\t\t\t<span class="toggle">\n\t\t\t\t\t\t<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M55.215 0v512l401.569-256z"/></svg>\n\t\t\t\t\t</span>\n\t\t\t\t\t<h3>${e.title}&nbsp;</h3>\n\t\t\t\t\t<div class="action_buttons">\n\t\t\t\t\t\t<button class="edit">\n\t\t\t\t\t\t\t<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M0 405.333V512h106.667l314.302-314.305L314.304 91.031zm503.469-290.136c11.375-11.374 11.375-28.445 0-39.82L436.622 8.531c-11.374-11.375-28.445-11.375-39.82 0l-52.624 52.625L450.844 167.82z"/></svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button class="delete">\n\t\t\t\t\t\t\t<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M85.334 455.239c0 31.222 25.597 56.761 56.889 56.761h227.556c31.291 0 56.888-25.539 56.888-56.761V128H85.334zm384-412.572H362.667L326.954 0H185.048l-35.714 42.667H42.667v42.666h426.667z"/></svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<span class="section_id">#${e.id}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="section_body" style="display: none;">\n\t\t\t\t\t<p>${e.description}</p>\n\t\t\t\t</div>\n\t\t\t`,n.appendChild(i),e.subsections&&e.subsections.length){const t=document.createElement("div");t.className="subsections",d(e.subsections,t),i.querySelector(".section_body").appendChild(t)}const c=t=>{const e=["#664d00","#6e2a0c","#691312","#5d0933","#291938","#042d3a","#12403c","#475200"],s=e.filter(e=>!t.includes(e));return s[Math.floor(Math.random()*s.length)]},r=t=>{const e=[],s=t=>{t&&t.classList.contains("section")&&t.dataset.background&&e.push(t.dataset.background)};s(t.previousElementSibling),s(t.nextElementSibling);const n=p(t.parentElement);s(n);const o=t.querySelector(".section_body .subsections");return o&&Array.from(o.children).filter(t=>t.classList.contains("section")).forEach(t=>{t.dataset.background&&e.push(t.dataset.background)}),e},u=t=>{const e=r(t),s=c(e);t.style.backgroundColor=s,t.dataset.background=s},p=t=>{for(;t&&!t.classList.contains("section");)t=t.parentElement;return t};i.querySelector(".toggle").addEventListener("click",function(){const t=i.querySelector(".section_body"),e="block"===t.style.display;e?(t.style.display="none",this.classList.remove("opened"),i.style.backgroundColor="",delete i.dataset.background):(t.style.display="block",this.classList.add("opened"),u(i))}),i.querySelector(".edit").addEventListener("click",function(){s(a(),e)}),i.querySelector(".delete").addEventListener("click",function(){const s=l(i);fetch("/sections/delete",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({id:e.id})}).then(t=>t.text()).then(e=>{try{const n=JSON.parse(e);if(n.success){i.remove();const e=1===s?"subsection":"subsections";if(showNotificationMessage(`Deleted section with ${s} ${e}`,"info"),0===t.querySelectorAll(".section").length){const e=document.createElement("p");e.className="no-sections",e.innerText="No sections available.",t.appendChild(e)}}else showNotificationMessage(n.error,"error")}catch(t){showNotificationMessage("Failed to parse JSON: "+t.message,"error")}}).catch(t=>showNotificationMessage("Error: "+t.message,"error"))})}),0===e.length&&!n.querySelector(".no-sections")){const t=document.createElement("p");t.className="no-sections",t.innerText="No sections available.",n.appendChild(t)}};r()});